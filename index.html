<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æœã”ã¯ã‚“ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ï¼ˆæœ€å¤§1000ï¼‰</title>
<style>
  body { font-family: system-ui, -apple-system, BlinkMacSystemFont; padding: 16px; }
  h1 { text-align:center; font-size:20px; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:12px; }
  select, input, button { font-size:14px; padding:6px 8px; }
  .info { text-align:center; margin-bottom:8px; font-size:14px; }
  .table-wrap { max-height:420px; overflow-y:auto; margin:0 auto; width:fit-content; border:1px solid #ccc; }
  table { border-collapse: collapse; }
  td { width:48px; height:48px; border:1px solid #999; text-align:center; font-size:22px; }
  .row-num { width:40px; text-align:left; padding-left:6px; font-size:12px; color:#555; border:none; }
  .settings { max-width:420px; margin:16px auto; border-top:2px solid #ccc; padding-top:12px; }
  .row { display:flex; justify-content:space-between; margin-bottom:8px; }
  #rewards td button { width:100%; box-sizing:border-box; padding:2px 4px; font-size:8px; }
  #rewards td { text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:14px; }
.history-box {
  border:1px solid #ccc;
  border-radius:8px;
  padding:8px;
  margin-bottom:10px;
  background:#fafafa;
}
.history-box h3 {
  margin:0 0 6px 0;
  font-size:14px;
}
.history-list {
  font-size:12px;
  line-height:1.5;
  max-height:120px;
  overflow-y:auto;
}

</style>
</head>
<body>

<h1>ğŸ æœã”ã¯ã‚“ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</h1>

<div class="controls">
  <div id="totals" style="width:100%; text-align:center; font-size:14px; margin-bottom:6px;"></div>
  <label>æ—¥ã«ã¡ <input type="date" id="date"></label>
  <label>
    ãªã¾ãˆ
    <select id="kid">
      <option value="">é¸æŠ</option>
      <option value="ç èœ">ç èœ</option>
      <option value="ç…Œ">ç…Œ</option>
      <option value="ç‰çœ">ç‰çœ</option>
    </select>
  </label>
  <button onclick="addStamp()">ã‚¹ã‚¿ãƒ³ãƒ—</button>
  <button onclick="removeOne()">1å€‹å‰Šé™¤</button>
  <button onclick="removeAll()">å…¨å‰Šé™¤</button>
</div>

<div class="table-wrap">
  <table>
    <tbody id="sheet"></tbody>
  </table>
</div>

<div class="settings">
  <h2>ğŸ æ™¯å“äº¤æ›</h2>
  <table style="width:100%; border-collapse:collapse; font-size:8px; table-layout: fixed;">
    <colgroup>
      <col style="width:15%;">
      <col style="width:70%;">
      <col style="width:15%;">
    </colgroup>
    <thead>
      <tr>
        <th>å¿…è¦æ•°</th>
        <th>æ™¯å“</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="rewards"></tbody>
  </table>
</div>

<div class="settings">
  <h2>âš™ ç›®æ¨™æ™‚é–“ï¼ˆå€‹äººåˆ¥ï¼‰</h2>
  <div class="row">ç èœ <input type="time" id="limit-ç èœ" value="07:30"></div>
  <div class="row">ç…Œ <input type="time" id="limit-ç…Œ" value="07:30"></div>
  <div class="row">ç‰çœ <input type="time" id="limit-ç‰çœ" value="07:30"></div>
</div>

<div class="settings">
  <h2>ğŸ“œ å…„å¼Ÿãã‚Œãã‚Œã®å±¥æ­´</h2>
  <div id="history"></div>
</div>

<script>
const COLS = 5;
const MAX = 1000;
const STAMP = { "ç èœ":"ğŸ“", "ç…Œ":"ğŸ”«", "ç‰çœ":"ğŸª²" };
const REWARDS = [
  { need: 10, label:"ã˜ã‚ƒãŒã‚Šã“ğŸŸ 1å€‹" },
  { need: 20, label:"ã˜ã‚ƒãŒã‚Šã“ğŸŸ 3å€‹" },
  { need: 30, label:"ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰å˜å“ğŸ” 3å€‹" },
  { need: 50, label:"ãƒ’ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚­ğŸ¥© 1æš" },
  { need:100, label:"ã‹ã«ğŸ¦€" },
  { need:200, label:"æ‰ä¹ƒäº•ãƒ›ãƒ†ãƒ«ğŸ¨" },
  { need:500, label:"ã‚¢ã‚«ãƒãƒ©ã‚¤ãƒ¢ãƒªğŸ¦" },
  { need:800, label:"ãƒ’ãƒ§ã‚¦ãƒ¢ãƒ³ãƒˆã‚«ã‚²ãƒ¢ãƒ‰ã‚­ğŸ¸" },
  { need:1000, label:"ãƒ•ãƒˆã‚¢ã‚´ãƒ’ã‚²ãƒˆã‚«ã‚²ğŸŠ" }
];

// ä»Šæ—¥ã®æ—¥ä»˜
function today() {
  const now = new Date();
  const jst = new Date(now.getTime() + 9*60*60*1000);
  const yyyy = jst.getFullYear();
  const mm = String(jst.getMonth()+1).padStart(2,'0');
  const dd = String(jst.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

// localStorage
function loadStamps() { return JSON.parse(localStorage.getItem("stamps1000")||"[]"); }
function saveStamps(data) { localStorage.setItem("stamps1000", JSON.stringify(data)); }
function loadLimits() {
  const limits = JSON.parse(localStorage.getItem("limits")||"{}");
  ["ç èœ","ç…Œ","ç‰çœ"].forEach(kid => { if(limits[kid]) document.getElementById(`limit-${kid}`).value = limits[kid]; });
}
function saveLimit(kid) {
  const value = document.getElementById(`limit-${kid}`).value;
  const limits = JSON.parse(localStorage.getItem("limits")||"{}");
  limits[kid] = value;
  localStorage.setItem("limits", JSON.stringify(limits));
}

// ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
["ç èœ","ç…Œ","ç‰çœ"].forEach(kid => {
  document.getElementById(`limit-${kid}`).addEventListener("change", () => saveLimit(kid));
});

// ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ 
function addStamp() {
  const date = document.getElementById("date").value;
  const kid = document.getElementById("kid").value;
  if (!date || !kid) { alert("æ—¥ã«ã¡ã¨ãªã¾ãˆã‚’é¸ã‚“ã§ãã ã•ã„"); return; }

  const stamps = loadStamps();
  if (stamps.length >= MAX) { alert("ã‚¹ã‚¿ãƒ³ãƒ—ã¯1000å€‹ã¾ã§ã§ã™"); return; }
  if (stamps.some(s=>s.date===date && s.kid===kid)) { alert("ã“ã®æ—¥ã¯ã™ã§ã«ã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚ã‚Šã¾ã™"); return; }

  // éå»æ—¥ã¯ä¸å¯
  const selectedDate = new Date(date);
  const todayDate = new Date(today());
  if (selectedDate < todayDate) { alert("éå»ã®æ—¥ä»˜ã«ã¯ã‚¹ã‚¿ãƒ³ãƒ—ã§ãã¾ã›ã‚“"); return; }

  // ä»Šæ—¥ã®å ´åˆã®ã¿ç›®æ¨™æ™‚é–“ãƒã‚§ãƒƒã‚¯
  if (date === today()) {
    const limitTime = document.getElementById(`limit-${kid}`).value;
    const [h,m] = limitTime.split(":").map(Number);
    const now = new Date();
    const limitDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0, 0);
    if (now > limitDate) { alert("ç›®æ¨™æ™‚é–“ã‚’éãã¦ã„ã¾ã™"); return; }
  }

  stamps.push({ date, kid });
  saveStamps(stamps);
  render();
}

// ã‚¹ã‚¿ãƒ³ãƒ—å‰Šé™¤
function removeOne() {
  const stamps = loadStamps();
  if (stamps.length===0) return;
  stamps.pop();
  saveStamps(stamps);
  render();
}
function removeAll() {
  if (!confirm("ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem("stamps1000");
  render();
}

// æ™¯å“äº¤æ›
function renderRewards(total) {
  const tbody = document.getElementById("rewards");
  tbody.innerHTML="";
  REWARDS.forEach(r=>{
    const tr=document.createElement("tr");
    const tdNeed=document.createElement("td"); tdNeed.textContent=r.need;
    const tdLabel=document.createElement("td"); tdLabel.textContent=r.label;
    const tdBtn=document.createElement("td");
    const btn=document.createElement("button");
    btn.textContent="äº¤æ›"; btn.disabled=total<r.need;
    btn.onclick=()=>exchange(r.need,r.label);
    tdBtn.appendChild(btn);
    tr.appendChild(tdNeed); tr.appendChild(tdLabel); tr.appendChild(tdBtn);
    tbody.appendChild(tr);
  });
}
function exchange(need,label){
  if(!confirm(`${need}å€‹ä½¿ã£ã¦ã€Œ${label}ã€ã¨äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  const stamps = loadStamps();
  stamps.splice(0, need);
  saveStamps(stamps);
  playAnimation(label);
  render();
}
function playAnimation(label){
  const anim=document.createElement("div");
  anim.textContent=`ğŸ‰ ${label} GET!! ğŸ‰`;
  anim.style.position="fixed";
  anim.style.top="50%"; anim.style.left="50%";
  anim.style.transform="translate(-50%,-50%) scale(0.5)";
  anim.style.fontSize="32px"; anim.style.background="rgba(255,255,255,0.95)";
  anim.style.padding="20px 30px"; anim.style.borderRadius="16px";
  anim.style.boxShadow="0 8px 20px rgba(0,0,0,0.3)";
  anim.style.transition="all 0.6s ease"; anim.style.zIndex="9999";
  document.body.appendChild(anim);
  requestAnimationFrame(()=>{ anim.style.transform="translate(-50%,-50%) scale(1.2)"; });
  setTimeout(()=>{ anim.style.opacity="0"; anim.style.transform="translate(-50%,-60%) scale(1)"; }, 1200);
  setTimeout(()=>anim.remove(),1800);
}

// è¡¨ã®æç”»
function render() {
  const stamps=loadStamps();
  const tbody=document.getElementById("sheet");
  tbody.innerHTML="";
  const count={ "ç èœ":0, "ç…Œ":0, "ç‰çœ":0 };
  stamps.forEach(s=>count[s.kid]++);
  const total=stamps.length;
  document.getElementById("totals").textContent=
    `åˆè¨ˆ ${total}å€‹ ï¼ ç èœ ${count["ç èœ"]} ãƒ» ç…Œ ${count["ç…Œ"]} ãƒ» ç‰çœ ${count["ç‰çœ"]}`;
  renderRewards(total);
  renderHistory(stamps);

function renderHistory(stamps){
  const box = document.getElementById("history");
  box.innerHTML = "";

  ["ç èœ","ç…Œ","ç‰çœ"].forEach(kid=>{
    const list = stamps.filter(s => s.kid === kid);

    const div = document.createElement("div");
    div.className = "history-box";

    const h3 = document.createElement("h3");
    h3.textContent = `${kid}ï¼ˆ${list.length}å€‹ï¼‰`;
    div.appendChild(h3);

    const ul = document.createElement("div");
    ul.className = "history-list";

    if(list.length === 0){
      ul.textContent = "ã¾ã ã‚¹ã‚¿ãƒ³ãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“";
    } else {
      ul.innerHTML = list
        .slice().reverse()
        .map(s => `ğŸ“… ${s.date}`)
        .join("<br>");
    }

    div.appendChild(ul);
    box.appendChild(div);
  });
}


  const totalRows = Math.ceil(MAX / COLS);
  for(let r=0;r<totalRows;r++){
    const tr=document.createElement("tr");
    for(let c=0;c<COLS;c++){
      const idx=r*COLS+c;
      const td=document.createElement("td");
      if(idx<stamps.length){
        const s=stamps[idx];
        td.textContent=STAMP[s.kid]||"â­";
        td.title=`${idx+1}å€‹ç›®ï¼š${s.date} ${s.kid}`;
      }
      tr.appendChild(td);
    }
    const num=document.createElement("td");
    num.className="row-num"; num.textContent=(r+1)*COLS;
    tr.appendChild(num);
    tbody.appendChild(tr);
  }
}

// åˆæœŸåŒ–
document.getElementById("date").value = today();
loadLimits();
render();
</script>

</body>
</html>
