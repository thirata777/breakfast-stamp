<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>æœã”ã¯ã‚“ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰ï¼ˆæœ€å¤§1000ï¼‰</title>
<style>
  body { font-family: system-ui, -apple-system, BlinkMacSystemFont; padding: 16px; }
  h1 { text-align:center; font-size:20px; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:12px; }
  select, input, button { font-size:14px; padding:6px 8px; }
  .table-wrap { max-height:420px; overflow-y:auto; margin:0 auto; width:fit-content; border:1px solid #ccc; }
  table { border-collapse: collapse; }
  td { width:48px; height:48px; border:1px solid #999; text-align:center; font-size:22px; cursor:pointer; }
  .row-num { width:40px; text-align:left; padding-left:6px; font-size:12px; color:#555; border:none; cursor:default; }
  .settings { max-width:420px; margin:16px auto; border-top:2px solid #ccc; padding-top:12px; }
  #rewards td button { width:100%; box-sizing:border-box; padding:2px 4px; font-size:8px; }
  #rewards td { text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:14px; }
  .history-box { border:1px solid #ccc; border-radius:8px; padding:8px; margin-bottom:10px; background:#fafafa; }
  .history-list { font-size:12px; max-height:120px; overflow:auto; }
  .parent-box { text-align:center; margin-bottom:10px; }
  .special-cell { background:#fff3a0; } /* ã‚¹ãƒšã‚·ãƒ£ãƒ«ã¯é»„è‰² */
</style>
</head>
<body>

<h1>ğŸ æœã”ã¯ã‚“ã‚¹ã‚¿ãƒ³ãƒ—ã‚«ãƒ¼ãƒ‰</h1>

<div class="parent-box">
  ğŸ”’ ä¿è­·è€…ãƒ¢ãƒ¼ãƒ‰ï¼š<b id="parentState">OFF</b>
  <button onclick="toggleParent()">åˆ‡æ›¿</button>
  <button onclick="changePin()">PINå¤‰æ›´</button>
</div>

<div class="controls">
  <label>æ—¥ã«ã¡ <input type="date" id="date"></label>
  <label>ãªã¾ãˆ
    <select id="kid">
      <option value="">é¸æŠ</option>
      <option value="ç èœ">ç èœ</option>
      <option value="ç…Œ">ç…Œ</option>
      <option value="ç‰çœ">ç‰çœ</option>
    </select>
  </label>
  <label><input type="checkbox" id="special"> ã‚¹ãƒšã‚·ãƒ£ãƒ«</label>
  <button onclick="addStamp()">ã‚¹ã‚¿ãƒ³ãƒ—</button>
  <button onclick="removeOne()">1å€‹å‰Šé™¤</button>
  <button onclick="removeAll()">å…¨å‰Šé™¤</button>
</div>

<div id="totals" style="text-align:center;margin-bottom:8px;"></div>

<div class="table-wrap">
  <table><tbody id="sheet"></tbody></table>
</div>

<div class="settings">
  <h2>ğŸ æ™¯å“äº¤æ›</h2>
  <table style="width:100%; border-collapse:collapse; font-size:8px; table-layout: fixed;">
    <thead>
      <tr><th>å¿…è¦æ•°</th><th>æ™¯å“</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody id="rewards"></tbody>
  </table>
</div>

<div class="settings">
  <h2>ğŸ“œ å…„å¼Ÿãã‚Œãã‚Œã®å±¥æ­´</h2>
  <div id="history"></div>
</div>

<script>
const COLS = 5;
const MAX = 1000;
const STAMP = { "ç èœ":"ğŸ“", "ç…Œ":"ğŸ”«", "ç‰çœ":"ğŸª²" };
const KIDS = ["ç èœ","ç…Œ","ç‰çœ"];
const REWARDS = [
  { need: 10, label:"ã˜ã‚ƒãŒã‚Šã“ğŸŸ 1å€‹" },
  { need: 20, label:"ã˜ã‚ƒãŒã‚Šã“ğŸŸ 3å€‹" },
  { need: 30, label:"ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰å˜å“ğŸ” 3å€‹" },
  { need: 50, label:"ãƒ’ãƒ¬ã‚¹ãƒ†ãƒ¼ã‚­ğŸ¥© 1æš" },
  { need:100, label:"ã‹ã«ğŸ¦€" },
  { need:200, label:"æ‰ä¹ƒäº•ãƒ›ãƒ†ãƒ«ğŸ¨" },
  { need:500, label:"ã‚¢ã‚«ãƒãƒ©ã‚¤ãƒ¢ãƒªğŸ¦" },
  { need:800, label:"ãƒ’ãƒ§ã‚¦ãƒ¢ãƒ³ãƒˆã‚«ã‚²ãƒ¢ãƒ‰ã‚­ğŸ¸" },
  { need:1000, label:"ãƒ•ãƒˆã‚¢ã‚´ãƒ’ã‚²ãƒˆã‚«ã‚²ğŸŠ" }
];

function today(){ return new Date().toISOString().slice(0,10); }
function loadStamps(){ return JSON.parse(localStorage.getItem("stamps1000")||"[]"); }
function saveStamps(d){ localStorage.setItem("stamps1000",JSON.stringify(d)); }

// PINï¼ˆåˆæœŸ 1234ï¼‰
function getPin(){ return localStorage.getItem("parentPin") || "1234"; }
function setPin(pin){ localStorage.setItem("parentPin", pin); }
let parentMode = false;

function toggleParent(){
  const pin = prompt("ä¿è­·è€…PINã‚’å…¥åŠ›ï¼ˆåˆæœŸ: 1234ï¼‰");
  if(pin !== getPin()) return alert("PINãŒé•ã„ã¾ã™");
  parentMode = !parentMode;
  document.getElementById("parentState").textContent = parentMode ? "ON" : "OFF";
}
function changePin(){
  const pin = prompt("ç¾åœ¨ã®PIN");
  if(pin !== getPin()) return alert("PINãŒé•ã„ã¾ã™");
  const newPin = prompt("æ–°ã—ã„4æ¡PIN");
  if(!/^\d{4}$/.test(newPin)) return alert("4æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
  setPin(newPin);
  alert("PINã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
}

function addStamp(){
  const kid = document.getElementById("kid").value;
  let date = document.getElementById("date").value;
  const special = document.getElementById("special").checked;
  if(!kid) return alert("ãªã¾ãˆã‚’é¸ã‚“ã§ãã ã•ã„");
  if(!parentMode) date = today();
  if(parentMode && special) date = "SPECIAL";
  const stamps = loadStamps();
  stamps.push({kid, date});
  saveStamps(stamps);
  render();
}

function removeOne(){
  if(!parentMode) return alert("ä¿è­·è€…ãƒ¢ãƒ¼ãƒ‰ã®ã¿å‰Šé™¤ã§ãã¾ã™");
  const s = loadStamps(); s.pop(); saveStamps(s); render();
}
function removeAll(){
  if(!parentMode) return alert("ä¿è­·è€…ãƒ¢ãƒ¼ãƒ‰ã®ã¿å‰Šé™¤ã§ãã¾ã™");
  if(confirm("å…¨éƒ¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    localStorage.removeItem("stamps1000"); render();
  }
}

function renderRewards(total){
  const tbody=document.getElementById("rewards");
  tbody.innerHTML="";
  REWARDS.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${r.need}</td><td>${r.label}</td>`;
    const td=document.createElement("td");
    const btn=document.createElement("button");
    btn.textContent="äº¤æ›";
    btn.disabled = total < r.need;
    btn.onclick = ()=>exchange(r.need, r.label);
    td.appendChild(btn);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });
}
function exchange(need,label){
  if(!parentMode) return alert("äº¤æ›ã¯ä¿è­·è€…ãƒ¢ãƒ¼ãƒ‰ã®ã¿");
  if(!confirm(`${need}å€‹ä½¿ã£ã¦ã€Œ${label}ã€ã¨äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  const s=loadStamps(); s.splice(0,need); saveStamps(s); render();
}

function render(){
  const stamps=loadStamps();
  const tbody=document.getElementById("sheet");
  tbody.innerHTML="";
  const count={}; KIDS.forEach(k=>count[k]=0);
  stamps.forEach(s=>count[s.kid]++);
  document.getElementById("totals").textContent =
    `åˆè¨ˆ ${stamps.length}å€‹ ï¼ ç èœ ${count["ç èœ"]} ãƒ» ç…Œ ${count["ç…Œ"]} ãƒ» ç‰çœ ${count["ç‰çœ"]}`;

  renderRewards(stamps.length);
  renderHistory(stamps);

  const rows=Math.ceil(MAX/COLS);
  for(let r=0;r<rows;r++){
    const tr=document.createElement("tr");
    for(let c=0;c<COLS;c++){
      const idx=r*COLS+c;
      const td=document.createElement("td");
      if(stamps[idx]){
        const s=stamps[idx];
        td.textContent = STAMP[s.kid];
        td.title = s.date==="SPECIAL" ? "ã‚¹ãƒšã‚·ãƒ£ãƒ«" : s.date;
        if(s.date==="SPECIAL") td.classList.add("special-cell");
        td.onclick = () => {
          if(!parentMode) return;
          if(confirm(`ã“ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${s.kid} / ${s.date}`)){
            const arr = loadStamps();
            arr.splice(idx,1);
            saveStamps(arr);
            render();
          }
        };
      }
      tr.appendChild(td);
    }
    const num=document.createElement("td");
    num.className="row-num"; num.textContent=(r+1)*COLS;
    tr.appendChild(num);
    tbody.appendChild(tr);
  }
}

function renderHistory(stamps){
  const box=document.getElementById("history");
  box.innerHTML="";
  KIDS.forEach(k=>{
    const list=stamps.filter(s=>s.kid===k);
    const div=document.createElement("div");
    div.className="history-box";
    div.innerHTML = `<b>${k}ï¼ˆ${list.length}å€‹ï¼‰</b><div class="history-list">${
      list.slice().reverse().map(s=>`ğŸ“… ${s.date}`).join("<br>") || "ãªã—"
    }</div>`;
    box.appendChild(div);
  });
}

document.getElementById("date").value = today();
render();
</script>
</body>
</html>
